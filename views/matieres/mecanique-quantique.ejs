<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mécanique Quantique</title>
  <link href="/stylesheets/style.css" rel="stylesheet">
  <style>
    .hidden { display: none; }
    #uploadModal {
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .custom-modal {
      border-top: 6px solid #5C83BA;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      position: relative;
      padding-top: 2.5rem;
      width: 100%;
    }
    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #5C83BA;
      cursor: pointer;
      transition: color 0.2s;
    }
    .close-btn:hover {
      color: #466a99;
    }
    .custom-modal h2 {
      margin-top: 0;
      color: #5C83BA;
      text-align: center;
    }
    .custom-modal form label {
      color: #1e293b;
    }
    .custom-modal form input,
    .custom-modal form select {
      border: 1px solid #cbd5e1;
      margin-bottom: 0.5rem;
    }
    .custom-modal form input:focus,
    .custom-modal form select:focus {
      border-color: #5C83BA;
      outline: none;
    }
    input[type="file"]::-webkit-file-upload-button {
      visibility: hidden;
      display: none;
    }
    input[type="file"]::file-selector-button {
      visibility: hidden;
      display: none;
    }
    input[type="file"] {
      color: transparent;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      width: 1px;
      min-width: 0;
      max-width: 0;
      height: 1px;
      overflow: hidden;
      position: absolute;
    }
    .file-label {
      position: relative;
    }
    .custom-file-btn {
      display: inline-block;
      background: #5C83BA;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
      margin-right: 0.5rem;
    }
    .custom-file-btn:hover {
      background: #466a99;
    }
    .file-chosen {
      font-weight: 500;
      color: #5C83BA;
      margin-left: 0.5rem;
    }
    .file-none {
      color: #64748b;
      font-style: italic;
      margin-left: 0.5rem;
    }
    .pdf-viewer-container {
      width: 100%;
      height: 60vh;
      min-height: 350px;
      max-height: 80vh;
      margin-bottom: 1rem;
    }
    .pdf-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    @media (max-width: 900px) {
      .pdf-viewer-container {
        height: 45vh;
        min-height: 220px;
      }
    }
    @media (max-width: 600px) {
      .pdf-viewer-container {
        height: 32vh;
        min-height: 140px;
      }
    }
    @media (max-width: 400px) {
      .pdf-viewer-container {
        height: 22vh;
        min-height: 90px;
      }
    }
    @media (max-width: 640px) {
      .custom-modal {
        padding: 1rem !important;
        border-radius: 10px;
        font-size: 0.97rem;
      }
      .custom-modal h2 {
        font-size: 1.1rem;
      }
    }
    /* Ajout pour rendre le quiz scrollable */
    .quiz-scroll-container {
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 8px;
      margin-bottom: 1em;
    }
    .quiz-scroll-container::-webkit-scrollbar {
      width: 8px;
      background: #f1f5f9;
    }
    .quiz-scroll-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <%- include('../partials/header.ejs') %>
  <%- include('../partials/head.ejs') %>
  <main class="p-2 sm:p-4 md:p-8 max-w-4xl mx-auto">
    <div class="mt-16 sm:mt-24"></div>
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
      <h1 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-4 text-center sm:text-left">Mécanique Quantique</h1>
      <button onclick="openModal()" class="w-full sm:w-auto bg-[#5C83BA] text-white px-4 py-2 rounded hover:bg-[#466a99] transition">
        + Ajouter un fichier
      </button>
    </div>
    <p class="text-base sm:text-lg text-center sm:text-left">Bienvenue sur la page de mécanique quantique.</p>
    
    <section class="mb-6">
      <button type="button" onclick="toggleContent('cours-content')" class="text-lg font-semibold mb-2 px-4 py-2 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition inline-block">
        Cours
      </button>
      <div id="cours-content" class="hidden mt-2">
        <% if (cours && cours.length > 0) { %>
          <ul style="margin-left: 1.5rem;">
            <% cours.forEach(function(file, idx) { 
              var fileId = file.link && file.link.split('/').pop();
              var safeName = (file.name || '').replace(/'/g, "\'").replace(/"/g, '&quot;');
            %>
              <li style="margin-bottom: 1rem;">
                <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem;">
                  <a href="javascript:void(0)" onclick="togglePdfMulti('<%= fileId %>', 'cours-pdf-viewer-<%= idx %>')" class="inline-block px-3 py-1 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition mb-1">
                    <%= file.name %>
                  </a>
                  <a href="<%= file.link %>" download="<%= file.name %>" class="inline-block px-3 py-1 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition mb-1" title="Télécharger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 20 20" style="vertical-align:middle;">
                      <path fill="currentColor" d="M10 2a1 1 0 0 1 1 1v8.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4A1 1 0 1 1 5.707 9.293L8 11.586V3a1 1 0 0 1 1-1zm-7 13a1 1 0 0 1 1 1v1h12v-1a1 1 0 1 1 2 0v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"/>
                    </svg>
                  </a>
                  <button type="button" class="inline-block px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition mb-1"
                    onclick="openQuizModal('<%= fileId %>', '<%= safeName %>')"
                    title="Quiz IA">
                    Quiz IA
                  </button>
                </div>
                <div id="cours-pdf-viewer-<%= idx %>" class="pdf-viewer-container" style="display:none;">
                  <iframe src="" class="pdf-frame" allowfullscreen></iframe>
                </div>
              </li>
            <% }); %>
          </ul>
        <% } else { %>
          <p class="text-gray-500" style="margin-left: 2.5rem;">Aucun cours disponible.</p>
        <% } %>
      </div>
    </section>
    
    <section class="mb-6">
      <button type="button" onclick="toggleContent('tds-content')" class="text-lg font-semibold mb-2 px-4 py-2 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition inline-block">
        TDs
      </button>
      <div id="tds-content" class="hidden mt-2">
        <% if (tds && tds.length > 0) { %>
          <ul style="margin-left: 1.5rem;">
            <% tds.forEach(function(file, idx) { %>
              <li style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <a href="javascript:void(0)" onclick="togglePdfMulti('<%= file.link.split('/').pop() %>', 'tds-pdf-viewer-<%= idx %>')" class="inline-block px-3 py-1 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition mb-1" style="margin-left: 0.5rem;">
                    <%= file.name %>
                  </a>
                  <a href="<%= file.link %>" download="<%= file.name %>" class="inline-block px-3 py-1 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition mb-1 ml-2" style="margin-left:0.5rem;" title="Télécharger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 20 20" style="vertical-align:middle;">
                      <path fill="currentColor" d="M10 2a1 1 0 0 1 1 1v8.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4A1 1 0 1 1 5.707 9.293L8 11.586V3a1 1 0 0 1 1-1zm-7 13a1 1 0 0 1 1 1v1h12v-1a1 1 0 1 1 2 0v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"/>
                    </svg>
                  </a>
                </div>
                <div id="tds-pdf-viewer-<%= idx %>" class="pdf-viewer-container" style="display:none; margin-left: 0.5rem;">
                  <iframe src="" class="pdf-frame" allowfullscreen></iframe>
                </div>
              </li>
            <% }); %>
          </ul>
        <% } else { %>
          <p class="text-gray-500" style="margin-left: 2.5rem;">Aucun TD disponible.</p>
        <% } %>
      </div>
    </section>
    
    <section class="mb-6">
      <button type="button" onclick="toggleContent('annales-content')" class="text-lg font-semibold mb-2 px-4 py-2 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition inline-block">
        Annales
      </button>
      <div id="annales-content" class="hidden mt-2">
        <% if (annales && annales.length > 0) { %>
          <ul style="margin-left: 1.5rem;">
            <% annales.forEach(function(file, idx) { %>
              <li style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <a href="javascript:void(0)" onclick="togglePdfMulti('<%= file.link.split('/').pop() %>', 'annales-pdf-viewer-<%= idx %>')" class="inline-block px-3 py-1 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition mb-1" style="margin-left: 0.5rem;">
                    <%= file.name %>
                  </a>
                  <a href="<%= file.link %>" download="<%= file.name %>" class="inline-block px-3 py-1 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition mb-1 ml-2" style="margin-left:0.5rem;" title="Télécharger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 20 20" style="vertical-align:middle;">
                      <path fill="currentColor" d="M10 2a1 1 0 0 1 1 1v8.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4A1 1 0 1 1 5.707 9.293L8 11.586V3a1 1 0 0 1 1-1zm-7 13a1 1 0 0 1 1 1v1h12v-1a1 1 0 1 1 2 0v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"/>
                    </svg>
                  </a>
                </div>
                <div id="annales-pdf-viewer-<%= idx %>" class="pdf-viewer-container" style="display:none; margin-left: 0.5rem;">
                  <iframe src="" class="pdf-frame" allowfullscreen></iframe>
                </div>
              </li>
            <% }); %>
          </ul>
        <% } else { %>
          <p class="text-gray-500" style="margin-left: 2.5rem;">Aucune annale disponible.</p>
        <% } %>
      </div>
    </section>
    
    <section class="mb-6">
      <button type="button" onclick="toggleContent('forum-content')" class="text-lg font-semibold mb-2 px-4 py-2 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] transition inline-block">
        Forum
      </button>
      <div id="forum-content" class="hidden mt-2">
        <button type="button" onclick="openAddDiscussionModal()" class="mb-4 bg-[#5C83BA] text-white px-4 py-2 rounded hover:bg-[#466a99] transition">
          + Ajouter une discussion
        </button>
        <!-- Modal pour ajouter une discussion -->
        <div id="addDiscussionModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none;">
          <div class="bg-white custom-modal p-3 sm:p-6 shadow-lg w-full max-w-sm sm:max-w-md md:max-w-lg">
            <button type="button" class="close-btn" onclick="closeAddDiscussionModal()" title="Fermer">&times;</button>
            <h2 class="text-lg sm:text-xl font-bold mb-4">Nouvelle discussion</h2>
            <form action="/forum/mecanique-quantique/add" method="POST">
              <div class="mb-3">
                <label class="block mb-1 font-medium">Nom de la discussion</label>
                <input type="text" name="discussionName" required class="w-full border px-2 py-1 rounded" placeholder="Titre de la discussion"/>
              </div>
              <div class="flex flex-col sm:flex-row justify-end gap-2">
                <button type="button" onclick="closeAddDiscussionModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 w-full sm:w-auto">Annuler</button>
                <button type="submit" class="px-4 py-2 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] w-full sm:w-auto">Créer</button>
              </div>
            </form>
          </div>
        </div>
        <script>
          function openAddDiscussionModal() {
            document.getElementById('addDiscussionModal').style.display = 'flex';
          }
          function closeAddDiscussionModal() {
            document.getElementById('addDiscussionModal').style.display = 'none';
          }
        </script>
        <% if (forum && forum.length > 0) { %>
          <ul style="margin-left: 1.5rem;">
            <% forum.forEach(function(discussion, idx) { 
              var discussionId = '';
              if (discussion && discussion._id) {
                if (typeof discussion._id === 'object' && discussion._id !== null && discussion._id.toHexString) {
                  discussionId = discussion._id.toHexString();
                } else if (typeof discussion._id === 'string' && /^[a-fA-F0-9]{24}$/.test(discussion._id)) {
                  discussionId = discussion._id;
                } else if (discussion._id && typeof discussion._id.toString === 'function') {
                  var strId = discussion._id.toString();
                  if (/^[a-fA-F0-9]{24}$/.test(strId)) {
                    discussionId = strId;
                  }
                }
              }
            %>
              <li style="margin-bottom: 1.5rem;">
                <div>
                  <span class="font-semibold text-[#5C83BA]"><%= discussion.name %></span>
                </div>
                <div class="mt-2" style="margin-left: 0.5rem;">
                  <div style="background:#f1f5f9; border-radius:8px; padding:1rem;">
                    <% if (discussion.messages && discussion.messages.length > 0) { %>
                      <ul class="forum-messages-list" id="forum-messages-<%= discussionId %>">
                        <% discussion.messages.forEach(function(msg) { %>
                          <li style="margin-bottom:0.5rem;">
                            <span class="font-bold text-[#5C83BA]">
                              <% if (msg.author && msg.author.username) { %>
                                <%= msg.author.username %>
                              <% } else if (msg.author) { %>
                                <%= msg.author %>
                              <% } else { %>
                                Anonyme
                              <% } %>
                              :
                            </span>
                            <span><%= msg.text %></span>
                          </li>
                        <% }); %>
                      </ul>
                    <% } else { %>
                      <ul class="forum-messages-list" id="forum-messages-<%= discussionId %>"></ul>
                      <p class="text-gray-500" id="no-msg-<%= discussionId %>">Aucun message pour cette discussion.</p>
                    <% } %>
                  </div>
                  <% if (discussionId && discussionId.length === 24) { %>
                  <form class="forum-message-form mt-2 flex flex-col sm:flex-row gap-2" data-discussion-id="<%= discussionId %>">
                    <input type="text" name="text" placeholder="Votre message" required class="border rounded px-2 py-1 flex-1" />
                    <button type="submit" class="bg-[#5C83BA] text-white px-3 py-1 rounded hover:bg-[#466a99]">Envoyer</button>
                  </form>
                  <% } %>
                </div>
              </li>
            <% }); %>
          </ul>
        <% } else { %>
          <p class="text-gray-500" style="margin-left: 2.5rem;">Aucune discussion de forum disponible.</p>
        <% } %>
      </div>
    </section>
    
  </main>
  <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none;">
    <div class="bg-white custom-modal p-3 sm:p-6 shadow-lg w-full max-w-sm sm:max-w-md md:max-w-lg">
      <button type="button" class="close-btn" onclick="closeModal()" title="Fermer">&times;</button>
      <h2 class="text-lg sm:text-xl font-bold mb-4">Ajouter un fichier</h2>
      <form action="/upload/mecanique-quantique" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label class="block mb-1 font-medium">Fichier PDF</label>
          <div class="file-label">
            <label class="custom-file-btn">
              Choisir un ou plusieurs fichiers
              <input type="file" name="pdfFile" accept=".pdf" required multiple onchange="updateFileName(this)"/>
            </label>
            <span id="file-chosen" class="file-none">Aucun fichier choisi</span>
          </div>
        </div>
        <div class="mb-3">
          <label class="block mb-1 font-medium">Nom du fichier</label>
          <input type="text" name="customName" placeholder="Nom affiché (optionnel)" class="w-full border px-2 py-1 rounded"/>
        </div>
        <div class="mb-3">
          <label class="block mb-1 font-medium">Catégorie</label>
          <select name="categorie" required class="w-full border px-2 py-1 rounded">
            <% if (true) { %><option value="cours">Cours</option><% } %>
            <% if (true) { %><option value="tds">Tds</option><% } %>
            <% if (false) { %><option value="tps">Tps</option><% } %>
            <% if (true) { %><option value="annales">Annales</option><% } %>
            <% if (true) { %><option value="forum">Forum</option><% } %>
          </select>
        </div>
        <div class="flex flex-col sm:flex-row justify-end gap-2">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 w-full sm:w-auto">Annuler</button>
          <button type="submit" class="px-4 py-2 bg-[#5C83BA] text-white rounded hover:bg-[#466a99] w-full sm:w-auto">Ajouter</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Modal Quiz IA -->
  <div id="quizModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none;">
    <div class="bg-white custom-modal p-3 sm:p-6 shadow-lg w-full max-w-lg relative" style="margin-top: 6rem;">
      <button type="button" class="close-btn" onclick="closeQuizModal()" title="Fermer">&times;</button>
      <h2 class="text-lg sm:text-xl font-bold mb-4" id="quizModalTitle">Quiz IA</h2>
      <div id="quizLoading" class="text-center text-blue-600 font-semibold" style="display:none;">Génération du quiz en cours...</div>
      <div id="quizError" class="text-center text-red-600 font-semibold" style="display:none;"></div>
      <div id="quizContent" class="quiz-scroll-container"></div>
      <div class="flex flex-col sm:flex-row justify-end gap-2 mt-4">
        <button type="button" onclick="closeQuizModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 w-full sm:w-auto">Fermer</button>
      </div>
    </div>
  </div>
  <%- include("../partials/footer.ejs") %>
  <script>
    function openModal() {
      document.getElementById('uploadModal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('uploadModal').style.display = 'none';
    }
    function toggleContent(id) {
      const content = document.getElementById(id);
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
      } else {
        content.classList.add('hidden');
      }
    }
    function updateFileName(input) {
      const fileChosen = document.getElementById('file-chosen');
      if (input.files && input.files.length > 0) {
        if (input.files.length === 1) {
          fileChosen.textContent = input.files[0].name;
        } else {
          fileChosen.textContent = input.files.length + ' fichiers sélectionnés';
        }
        fileChosen.className = 'file-chosen';
      } else {
        fileChosen.textContent = 'Aucun fichier choisi';
        fileChosen.className = 'file-none';
      }
    }
    function togglePdfMulti(pdfId, viewerId) {
      const viewer = document.getElementById(viewerId);
      if (!viewer) return;
      const frame = viewer.querySelector('iframe');
      if (!frame) return;
      if (viewer.style.display === 'block') {
        viewer.style.display = 'none';
        frame.src = '';
      } else {
        frame.src = '/view/' + pdfId + '#zoom=90';
        viewer.style.display = 'block';
      }
    }
    // Quiz IA Front
    function openQuizModal(fileId, fileName) {
      document.getElementById('quizModal').style.display = 'flex';
      document.getElementById('quizModalTitle').textContent = 'Quiz IA : ' + fileName;
      document.getElementById('quizLoading').style.display = '';
      document.getElementById('quizError').style.display = 'none';
      document.getElementById('quizContent').innerHTML = '';
      fetchQuizIA(fileId);
    }
    function closeQuizModal() {
      document.getElementById('quizModal').style.display = 'none';
    }
    async function fetchQuizIA(fileId) {
      try {
        const res = await fetch('/api/quiz-from-doc/' + fileId, { method: 'GET' });
        document.getElementById('quizLoading').style.display = 'none';
        if (!res.ok) {
          let err = { error: 'Erreur lors de la génération du quiz.' };
          try { err = await res.json(); } catch {}
          document.getElementById('quizError').style.display = '';
          document.getElementById('quizError').textContent = err.error || 'Erreur lors de la génération du quiz.';
          return;
        }
        const data = await res.json();
        if (!data.quiz || !Array.isArray(data.quiz) || data.quiz.length === 0) {
          document.getElementById('quizError').style.display = '';
          document.getElementById('quizError').textContent = 'Aucun quiz généré.';
          return;
        }
        renderQuiz(data.quiz);
      } catch (e) {
        document.getElementById('quizLoading').style.display = 'none';
        document.getElementById('quizError').style.display = '';
        document.getElementById('quizError').textContent = 'Erreur réseau ou serveur.';
      }
    }
    // À copier/coller dans chaque page matière pour le quiz IA (fonctionne partout) :

    
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.forum-message-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const discussionId = this.getAttribute('data-discussion-id');
          const input = this.querySelector('input[name="text"]');
          const text = input.value.trim();
          if (!text) return;
          const res = await fetch(`/forum/mecanique-quantique/${discussionId}/message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ text })
          });
          if (res.ok) {
            input.value = '';
          }
        });
      });

      socket.on('forumMessage', function(data) {
        if (data && data.discussionId && data.text && data.author) {
          addForumMessageToDOM(data.discussionId, data.author, data.text);
        }
      });

      function addForumMessageToDOM(discussionId, author, text) {
        const ul = document.getElementById('forum-messages-' + discussionId);
        if (ul) {
          const li = document.createElement('li');
          li.innerHTML = '<span class="font-bold text-[#5C83BA]">' + author + ' :</span> <span>' + text + '</span>';
          ul.appendChild(li);
        }
        const noMsg = document.getElementById('no-msg-' + discussionId);
        if (noMsg) {
          noMsg.style.display = 'none';
        }
      }
    });
  </script>
</body>
</html>
