<!DOCTYPE html>
<%- include('partials/head.ejs') %>
<html>
<head>
  <title>Mentorat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#FAF3E5]">
    <%- include('partials/header.ejs') %>

  <main class="flex flex-col items-center p-4 pt-20">
    <div class="relative flex rounded-full bg-gray-200 p-1 w-fit mt-10">
   <!-- Slider de fond -->
    <div id="slider" class="absolute left-0 top-0 h-full w-1/2 bg-[#5C83BA] rounded-full transition-all duration-300 ease-in-out z-0"></div>

      <button id="tab-eleve" class="relative z-10 px-4 py-1 text-white rounded-l-full focus:outline-none w-24">√âl√®ve</button>
      <button id="tab-enseignant" class="relative z-10 px-4 py-1 text-black rounded-r-full focus:outline-none w-24">Enseignant</button>
    </div>

      <!-- Contenus -->
    <div id="contenu-eleve" class="w-full text-center mt-10">
      <!-- Filtres par module (checkbox) -->
      <div id="filtreModules" class="flex flex-wrap justify-center gap-4 my-6">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" class="filter-checkbox hidden peer">
          <span class="peer-checked:bg-blue-400 peer-checked:text-white bg-blue-200 text-black px-4 py-2 rounded-full font-semibold transition">
            Maths
          </span>
        </label>

        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" class="filter-checkbox hidden peer">
          <span class="peer-checked:bg-blue-400 peer-checked:text-white bg-blue-200 text-black px-4 py-2 rounded-full font-semibold transition">
            Physique
          </span>
        </label>

        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" class="filter-checkbox hidden peer">
          <span class="peer-checked:bg-blue-400 peer-checked:text-white bg-blue-200 text-black px-4 py-2 rounded-full font-semibold transition">
            Informatique
          </span>
        </label>

        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" class="filter-checkbox hidden peer">
          <span class="peer-checked:bg-blue-400 peer-checked:text-white bg-blue-200 text-black px-4 py-2 rounded-full font-semibold transition">
            Communication
          </span>
        </label>
      </div>
      
      <div id="mentorats-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4"></div>
    </div>


    <!-- Section confirmation (initialement cach√©e) -->
    <div id="confirmationPage" class="hidden flex flex-col items-center p-4 gap-4">
      <div class="bg-blue-200 rounded-xl p-4 w-full max-w-xs text-center">
        <div class="text-2xl mb-2">üïí</div>
        <p id="confirmationText" class="text-lg font-semibold mb-4"></p>
        <div class="flex justify-center gap-4">
          <button id="btnOui" class="bg-green-400 text-white px-4 py-1 rounded-full hover:bg-green-500">Oui</button>
          <button id="btnNon" class="bg-red-400 text-white px-4 py-1 rounded-full hover:bg-red-500">Non</button>
        </div>
      </div>
    </div>

    <div id="contenu-enseignant" class="w-full text-center hidden mt-10">
      <div id="homePage">
        <button id="btnAfficherCours" class="bg-blue-300 rounded-full px-6 py-2 font-semibold hover:bg-blue-400 transition">Voir mes cours existants</button>
        <button id="btnCreerCours" class="bg-blue-300 rounded-full px-6 py-2 font-semibold hover:bg-blue-400 transition">Cr√©er un nouveau cours</button>
      </div>
    </div>

    <div id="formulairePage" class="hidden w-full max-w-md bg-white p-6 rounded-xl shadow-lg mt-10">
      
      <form id="formCours" class="space-y-4" method="POST">
        <div>
          <label class="block font-semibold mb-1">Mati√®re :</label>
          <input type="text" name="matiere" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Ex: Transformation Int√©grale">
        </div>

        <div>
          <label class="block font-semibold mb-1">Dur√©e :</label>
          <input type="time" name="duree" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
        </div>

        <div>
          <label class="block font-semibold mb-1">Heure de d√©but :</label>
          <select name="heure_debut" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
            <% for (let h = 7; h <= 20; h++) { %>
              <option value="<%= h %>:00"><%= h %>h</option>
            <% } %>
          </select>
        </div>

        <div>
          <label class="block font-semibold mb-1">Date du cours :</label>
          <input type="date" name="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300" required>
        </div>

        <div>
          <label class="block font-semibold mb-1">Module :</label>
          <select name="module" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300">
            <option>Maths</option>
            <option>Physique</option>
            <option>Informatique</option>
            <option>Communication</option>
          </select>
        </div>

        <div>
          <label class="block font-semibold mb-1">Message (optionnel)</label>
          <textarea name="message" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Ton message..."></textarea>
        </div>

        <button type="submit" class="w-full bg-blue-400 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 transition">
          Enregistrer
        </button>
      </form>
    </div>

  <div id="coursPage" class="hidden flex flex-col items-center p-4 gap-4">

    <p class="font-bold text-lg mt-4">Mes cours disponibles :</p>

    <div id="coursContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl">
      <!-- Les cartes de cours seront inject√©es ici -->
    </div>
  </div>


</main>




  <%- include("partials/footer.ejs") %>
  <script>
    let mentoratsTous = [];



    document.addEventListener('DOMContentLoaded', () => {
      if (!contenuEleve.classList.contains('hidden')) {
        chargerMentorats();
      }
    });
    document.querySelectorAll('.filter-checkbox').forEach(cb => {
      cb.addEventListener('change', () => {
        afficherMentoratsFiltres();
      });
    });


    const tabEleve = document.getElementById('tab-eleve');
    const tabEnseignant = document.getElementById('tab-enseignant');
    const slider = document.getElementById('slider');
    const contenuEleve = document.getElementById('contenu-eleve');
    const contenuEnseignant = document.getElementById('contenu-enseignant');

    tabEleve.addEventListener('click', () => {
      slider.style.left = '0%';
      tabEleve.classList.replace('text-black', 'text-white');
      tabEnseignant.classList.replace('text-white', 'text-black');
      contenuEleve.classList.remove('hidden');
      contenuEnseignant.classList.add('hidden');
      document.getElementById('confirmationPage').classList.add('hidden');
      coursPage.classList.add('hidden');
      formulairePage.classList.add('hidden');
      chargerMentorats();
    });

    tabEnseignant.addEventListener('click', () => {
      slider.style.left = '50%';
      tabEnseignant.classList.replace('text-black', 'text-white');
      tabEleve.classList.replace('text-white', 'text-black');
      contenuEleve.classList.add('hidden');
      contenuEnseignant.classList.remove('hidden');
      document.getElementById('confirmationPage').classList.add('hidden');
      coursPage.classList.add('hidden');
      formulairePage.classList.add('hidden');
    });

    function addMentorat(matiere, titre, intervenant, duree, heure_debut = null, heure_fin = null, id = null, date = null){
      
      const container = document.getElementById('mentorats-container');
      const card = document.createElement('div');
      card.className = "bg-blue-200 rounded-2xl p-4 flex flex-col items-center text-center shadow-md";
      card.dataset.id = id;

      card.innerHTML = `
        <div class="text-3xl mb-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
            </svg></div>
        <h3 class="text-lg font-semibold mb-3">${titre}</h3>
        <ul class="text-sm mb-5">
          <li>Pr√©sent√© par : ${intervenant}</li>
          <li>Dur√©e : ${duree}</li>
          ${heure_debut && heure_fin ? `<li>Cr√©neau : ${heure_debut} - ${heure_fin}</li>` : ''}
          <li>Date : ${new Date(date).toLocaleDateString('fr-FR')}</li>
        </ul>
        <button class="bg-white text-sm font-medium border border-gray-400 px-3 py-1 rounded-full hover:bg-gray-100 transition">
          R√©server un cr√©neau
        </button>
      `;

      const boutonReserver = card.querySelector('button');

      boutonReserver.addEventListener('click', () => {
        mentoratActif = card;
        creneauSelectionne = "horaire √† d√©finir"; // Tu peux adapter ce texte

        document.getElementById('confirmationText').textContent = `Voulez-vous r√©server ce mentorat ?`;
        document.getElementById('contenu-eleve').classList.add('hidden');
        document.getElementById('confirmationPage').classList.remove('hidden');
      });


      container.appendChild(card);
    }


    
    // Exemple d'ajout
    //document.addEventListener('DOMContentLoaded', () => {
    //    addMentorat('Maths', 'Transformation int√©gral', 'L√©o Lammar', '2h');
    //    addMentorat('Physique', 'Analyse des signaux', 'L√©o Lammar', '1h30');
    //    addMentorat('Informatique', 'Algorithmique avanc√©e', 'L√©o Lammar', '2h');
    //    addMentorat('Maths', 'Probabilit√©s', 'L√©o Lammar', '1h45');
    //});

        // R√©f√©rences des pages
    const homePage = document.getElementById('homePage');
    const formulairePage = document.getElementById('formulairePage');
    const coursPage = document.getElementById('coursPage');

    // Boutons
    const btnAfficherCours = document.getElementById('btnAfficherCours');
    const btnCreerCours = document.getElementById('btnCreerCours');

    btnCreerCours.addEventListener('click', () => {
      formulairePage.classList.remove('hidden');
      coursPage.classList.add('hidden'); // Masquer les cours
    });


    // Exemple de donn√©es de cours pour affichage
    const coursContainer = document.getElementById('coursContainer');

    function addMentoratEnseignant(titre, duree, module = '', message = '', id = '') {
      const card = document.createElement('div');
      card.className = "bg-blue-200 rounded-2xl p-4 text-center shadow-md";
      card.innerHTML = `
        <div class="text-2xl mb-2">üë§</div>
        <h3 class="text-lg font-semibold mb-1">${titre}</h3>
        <p class="text-sm mb-1">Dur√©e : ${duree}</p>
        ${module ? `<p class="text-sm mb-1">Module : ${module}</p>` : ''}
        ${message ? `<p class="text-sm italic">"${message}"</p>` : ''}
        <button class="btn-supprimer bg-white text-red-500 font-semibold border border-red-500 px-3 py-1 rounded-md hover:bg-red-100 transition">
          Supprimer
        </button>
      `;

      const btnSupprimer = card.querySelector('.btn-supprimer');
      btnSupprimer.addEventListener('click', () => supprimerCours(id, card));

      coursContainer.appendChild(card);
    }


    // Exemple de cours affich√©s
    //addMentoratEnseignant('Transformation int√©gral', '2h');


    let creneauSelectionne = null;
    let mentoratActif = null;

    function afficherConfirmation(creneau) {
      creneauSelectionne = creneau;
      document.getElementById('confirmationText').textContent = `Voulez-vous r√©server le cr√©neau : ${creneau} ?`;
      document.getElementById('confirmationPage').classList.remove('hidden');
    }

    const btnOui = document.getElementById('btnOui');
    const btnNon = document.getElementById('btnNon');    


    btnOui.addEventListener('click', async () => {
      if (mentoratActif) {
        const coursId = mentoratActif.dataset.id;

        try {
          const response = await fetch(`/mentorat/reserver/${coursId}`, {
            method: 'DELETE'
          });

          const result = await response.json();
          console.log("R√©ponse serveur :", result);

          if (result.success) {
            mentoratActif.remove();
          } else {
            alert("Erreur : " + result.error);
          }
        } catch (err) {
          console.error(err);
          alert("Erreur lors de la suppression du cours.");
        }

        mentoratActif = null;
      }

      document.getElementById('confirmationPage').classList.add('hidden');
      document.getElementById('contenu-eleve').classList.remove('hidden');
    });



    btnNon.addEventListener('click', () => {
      // Revenir √† la liste des cr√©neaux
      document.getElementById('confirmationPage').classList.add('hidden');
      document.getElementById('contenu-eleve').classList.remove('hidden');
    });
   

    document.getElementById('formCours').addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = e.target;
      const data = {
        matiere: form.matiere.value,
        duree: form.duree.value,
        module: form.module.value,
        message: form.message.value,
        heure_debut: form.heure_debut.value,
        date: form.date.value
      };

      const res = await fetch('/mentorat/creer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (result.success) {
        alert('Cours enregistr√© avec succ√®s');
        form.reset();
      } else {
        alert(result.error || 'Erreur lors de la cr√©ation');
      }
    });


    async function chargerCours() {
      const res = await fetch('/mentorat/mes-cours');
      const result = await res.json();

      if (result.success) {
        coursContainer.innerHTML = '';
        result.cours.forEach(c => {
          addMentoratEnseignant(c.matiere, c.duree, c.module, c.message, c._id);
        });
      } else {
        alert('Erreur lors du chargement des cours');
      }
    }

    // Quand on clique sur "Voir mes cours existants"
    btnAfficherCours.addEventListener('click', async () => {
      coursPage.classList.remove('hidden');
      formulairePage.classList.add('hidden');
      await chargerCours();
    });

    async function supprimerCours(id, element) {
      if (!confirm("Confirmer la suppression de ce cours ?")) return;

      const res = await fetch(`/mentorat/supprimer/${id}`, {
        method: 'DELETE'
      });

      const result = await res.json();
      if (result.success) {
        element.remove();
      } else {
        alert(result.error || "√âchec de la suppression.");
      }
    }

    async function chargerMentorats() {
      const res = await fetch('/mentorat/liste');
      const result = await res.json();
      


      if (result.success) {
        mentoratsTous = result.cours; // stocke tous les cours
        afficherMentoratsFiltres();   // affiche selon les filtres actifs
        const container = document.getElementById('mentorats-container');
        container.innerHTML = '';

        result.cours.forEach(c => {
          const intervenant = `${c.enseignant_prenom || ''} ${c.enseignant_nom || ''}`.trim();
          addMentorat(
            c.module,
            c.matiere,
            `${c.enseignant_prenom} ${c.enseignant_nom}`,
            c.duree,
            c.heure_debut,
            c.heure_fin,
            c._id,
            c.date
          );
        });
      } else {
        alert('Erreur lors du chargement des cours.');
      }
    }
    function afficherMentoratsFiltres() {
      const container = document.getElementById('mentorats-container');
      container.innerHTML = '';

      // R√©cup√®re les modules coch√©s
      const modulesActifs = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
        .map(input => input.nextElementSibling.textContent.trim());

      // Filtrer les cours
      const mentoratsFiltres = modulesActifs.length === 0
        ? mentoratsTous
        : mentoratsTous.filter(c => modulesActifs.includes(c.module));

      // Afficher les cours filtr√©s
      mentoratsFiltres.forEach(c => {
        addMentorat(
          c.module,
          c.matiere,
          `${c.enseignant_prenom} ${c.enseignant_nom}`,
          c.duree,
          c.heure_debut,
          c.heure_fin
        );
      });
    }


  </script>

</body>
</html>
